# ZED Camera + PointNet Semantic Segmentation on NVIDIA Jetson

This modified PointNet repository enables semantic segmentation of ZED camera point clouds on NVIDIA Jetson devices.

## Features

- **ZED Camera Support**: Process `.ply` files generated by ZED cameras
- **Custom ShapeNet Format**: Support for `category_id/object_id.txt` format
- **Jetson Optimization**: Optimized for NVIDIA Jetson devices
- **Semantic Segmentation**: Output segmented point clouds as `.txt files

## Quick Start

### 1. Setup

```bash
# Make setup script executable
chmod +x setup_zed_jetson.sh

# Run setup (will install dependencies and optimize for Jetson)
./setup_zed_jetson.sh
```

### 2. Prepare Data

#### ShapeNet Data Format
Your ShapeNet data should be organized as:
```
data/shapenet/
├── 03001627/          # Chair category
│   ├── 678988644.txt  # Point cloud with labels
│   └── 789123456.txt
├── 02691156/          # Airplane category
│   └── 123456789.txt
└── ...
```

Each `.txt` file contains:
```
# x y z label
0.123 0.456 0.789 1
0.234 0.567 0.890 2
0.345 0.678 0.901 1
...
```

#### ZED Camera Data
Place your ZED camera PLY files in:
```
data/zed_output/
├── zed_out.ply
└── ...
```

### 3. Training

Train a segmentation model on your ShapeNet data:

```bash
# Train on Chair category
python3 utils/train_custom_segmentation.py \
    --dataset data/shapenet \
    --class_choice 03001627 \
    --jetson \
    --nepoch 25 \
    --outf models/chair_model

# Train on multiple categories
python3 utils/train_custom_segmentation.py \
    --dataset data/shapenet \
    --jetson \
    --nepoch 25 \
    --outf models/multi_class_model
```

### 4. Inference on ZED Data

Run semantic segmentation on ZED camera output:

```bash
python3 utils/zed_inference.py \
    --input data/zed_output/zed_out.ply \
    --output results/segmentation.txt \
    --model models/chair_model/seg_model_best.pth \
    --class_choice Chair \
    --jetson
```

## Scripts Overview

### Core Scripts

- **`utils/zed_inference.py`**: Main inference script for ZED PLY files
- **`utils/train_custom_segmentation.py`**: Training script for custom ShapeNet format
- **`utils/custom_shapenet_dataset.py`**: Dataset loader for your data format
- **`utils/jetson_optimize.py`**: Jetson-specific optimizations

### Training Options

```bash
python3 utils/train_custom_segmentation.py \
    --dataset <path_to_shapenet_data> \
    --class_choice <shapenet_category_id> \
    --batchSize 16 \
    --nepoch 25 \
    --jetson \
    --feature_transform
```

### Inference Options

```bash
python3 utils/zed_inference.py \
    --input <zed_ply_file> \
    --output <segmentation_result.txt> \
    --model <trained_model.pth> \
    --class_choice <object_class> \
    --npoints 2500 \
    --jetson
```

## ShapeNet Category IDs

ShapeNet categories:
- `02691156`: Airplane
- `02773838`: Bag
- `02954340`: Cap
- `02958343`: Car
- `03001627`: Chair
- `03261776`: Earphone
- `03467517`: Guitar
- `03624134`: Knife
- `03636649`: Lamp
- `03642806`: Laptop
- `03790512`: Motorbike
- `03797390`: Mug
- `03948459`: Pistol
- `04099429`: Rocket
- `04225987`: Skateboard
- `04379243`: Table

## Jetson Optimizations

The repository includes several Jetson-specific optimizations:

### Performance Settings
- Maximum performance mode (`nvpmodel -m 0`)
- Maximum clock speeds (`jetson_clocks`)
- Optimized memory allocation (80% GPU memory)

### Training Optimizations
- Reduced batch size (16 instead of 32)
- Fewer data loader workers (2 instead of 4)
- Mixed precision training support
- Memory-efficient data loading

### Monitoring
Monitor your Jetson during training:
```bash
# Temperature monitoring
watch -n 1 cat /sys/class/thermal/thermal_zone*/temp

# GPU utilization
watch -n 1 nvidia-smi

# Memory usage
watch -n 1 free -h
```

## Output Format

The segmentation results are saved as text files:
```
# Point Cloud Segmentation Results
# Format: x y z label
# Class mapping:
# 0: back
# 1: seat
# 2: leg
# 3: arm

0.123456 0.234567 0.345678 1
0.234567 0.345678 0.456789 2
0.345678 0.456789 0.567890 1
...
```

## Troubleshooting

### Common Issues

1. **CUDA Out of Memory**
   - Reduce batch size: `--batchSize 8`
   - Reduce points: `--npoints 1000`
   - Increase memory fraction in `jetson_optimize.py`

2. **Slow Training**
   - Ensure performance mode is set: `sudo nvpmodel -m 0`
   - Check temperature throttling
   - Reduce number of workers: `--workers 1`

3. **Model Loading Errors**
   - Ensure model was trained with same number of classes
   - Check model info file: `<model_name>_info.json`

### Jetson-Specific Issues

1. **Performance Mode**
   ```bash
   sudo nvpmodel -m 0
   sudo jetson_clocks
   ```

2. **Memory Issues**
   ```bash
   # Create swap file
   sudo fallocate -l 4G /swapfile
   sudo chmod 600 /swapfile
   sudo mkswap /swapfile
   sudo swapon /swapfile
   ```

3. **Temperature Monitoring**
   ```bash
   # Check current temperature
   cat /sys/class/thermal/thermal_zone*/temp
   
   # Set fan to maximum (if available)
   sudo sh -c 'echo 255 > /sys/devices/pwm-fan/target_pwm'
   ```

## File Structure

```
pointnet.pytorch/
├── data/
│   ├── shapenet/           # Your ShapeNet data
│   └── zed_output/         # ZED camera PLY files
├── models/                 # Trained models
├── results/                # Segmentation results
├── utils/
│   ├── zed_inference.py
│   ├── train_custom_segmentation.py
│   ├── custom_shapenet_dataset.py
│   └── jetson_optimize.py
├── pointnet/
│   ├── dataset.py          # Modified with custom dataset support
│   └── model.py            # PointNet model
├── setup_zed_jetson.sh     # Setup script
└── README_ZED_JETSON.md    # This file
```

## Performance Expectations

On NVIDIA Jetson devices:
- **Jetson Nano**: ~5-10 FPS inference
- **Jetson TX2**: ~10-15 FPS inference  
- **Jetson Xavier NX**: ~15-25 FPS inference
- **Jetson AGX Xavier**: ~25-40 FPS inference
- **Jetson Orin**: ~40-60 FPS inference

Training times vary based on dataset size and Jetson model.
